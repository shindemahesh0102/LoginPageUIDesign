import{_ as S,M as _,I as W,r as u,o as i,c as o,g as d,b as l,a as h,ac as b,w as C,K as v,t as m,F as L,z as k,n as U}from"./bootstrap-5b74a21d.mjs";import{u as D}from"./useContainerPixelWidth-5aa56ad1.mjs";import"./useWindowDimensions-da63f265.mjs";const M={props:{percentOfContentArea:{type:Number,required:!0},identifier:{type:String,required:!0},description:{type:String},url:{type:String,required:!1},dateFormat:{type:String,default:"MMM Do, yyyy h:mma"},latestCommentsHeader:{type:String,default:"Latest Comments"}},data(){var e;return{body:"",error:null,totalCount:0,comments:[],archived:!1,hasNextPage:!1,endCursor:null,after:null,isLoading:!1,isLoadingMore:!1,isLoginFormDisplayed:!1,isReporting:!1,isAuthenticated:!1,isSubmitDisabled:!1,consentedForTargeting:((e=_("OptanonConsent").value)==null?void 0:e.search("C0004:1"))>0}},computed:{containerPixelWidth(){return D(this.percentOfContentArea)},currentDisplayName:{get(){return this.updatedDisplayName||this.siteUser.displayName},set(e){this.updatedDisplayName=e}},consentedEnforcement(){var e;return((e=this.$ss.oneTrust)==null?void 0:e.enableOneTrustEnforcment)&&!this.consentedForTargeting}},async mounted(){this.siteUser=await this.$idx.getUser(),this.isAuthenticated=this.$idx.isLoggedIn(),this.load(),this.updatedTargetingConsent()},methods:{formatDate(e){return W(e,"MMM do, yyyy h:mma")},showComment(e,a){return(a==null?void 0:a.id)===e.user.id||!e.user.banned},async load(){this.error=null,this.isLoading=!0;const{after:e}=this,a={identifier:this.identifier,after:e},t=await this.$idx.getCommentStream(a);if(t.error)this.error=t.message;else{this.totalCount=t.data.totalCount;const c=await this.$idx.getUser();this.comments=t.data.items.filter(s=>this.showComment(s,c)),this.hasNextPage=t.data.pageInfo.hasNextPage,this.endCursor=t.data.pageInfo.endCursor,this.archived=t.data.stream?t.data.stream.archived:!1,!this.comments[0]&&this.hasNextPage&&this.loadMore()}this.isLoading=!1},async loadMore(){this.error=null,this.isLoadingMore=!0;const{endCursor:e}=this,a={identifier:this.identifier,after:e},t=await this.$idx.getCommentStream(a);if(t.error)this.error=t.message;else{this.totalCount=t.data.totalCount;const c=await this.$idx.getUser();this.comments=this.comments.concat(t.data.items.filter(s=>this.showComment(s,c))),this.hasNextPage=t.data.pageInfo.hasNextPage,this.endCursor=t.data.pageInfo.endCursor,this.archived=t.data.stream?t.data.stream.archived:!1}this.isLoadingMore=!1},async reportComment(e){if(this.isReporting)return;this.error=null,this.isReporting=!0;const a={id:e},t=await this.$idx.flagComment(a);t.error?this.error=t.message:this.load(),this.isReporting=!1},async submitComment(){this.isSubmitDisabled=!0,this.error=null,this.isLoading=!0;const{identifier:e,title:a,description:t,url:c,currentDisplayName:s,body:r}=this,p={displayName:s,body:r.replace(/(<([^>]+)>)/gi,""),stream:{identifier:e,title:a,description:t,url:c}},y=await this.$idx.submitComment(p);y.error?this.error=y.message:this.load(),this.isLoading=!1,this.isSubmitDisabled=!1,this.body=""},updatedTargetingConsent(){var e,a;((e=this.$ss.oneTrust)==null?void 0:e.enableOneTrustEnforcment)&&((a=this.$ss.oneTrust)==null?void 0:a.scriptId)&&OneTrust.OnConsentChanged(()=>{var t;this.consentedForTargeting=((t=_("OptanonConsent").value)==null?void 0:t.search("C0004:1"))>0})}}},F={key:0,class:"header-text"},T={key:0},w={key:1,class:"comment-form"},P={key:0},z={key:1},O={key:0,class:"mb-0 mt-3"},A={key:2},I={key:3,class:"latest-comments-header"},E={key:1},B={key:2},R={key:3,class:"no-comments"},q={key:4},V=["data-id"],j={class:"comment-meta"},H={key:0},K={key:1},G={key:0},J=["onClick"],Q={key:0},X={key:0},Y={key:0},Z={key:1};function $(e,a,t,c,s,r){const p=u("LazyWebIdxFeatureOff"),y=u("LazyWebUserDisplayName"),N=u("LazyWebUserCommentBody"),f=u("LazyWebButtonElement"),x=u("LazyWebUserLoginForm");return i(),o("div",{class:"ebm-user-comments",style:U({fontFamily:e.$ss.primaryFontFamily})},[s.isAuthenticated?d("",!0):(i(),o("div",F," This site requires you to register or login to post a comment. ")),l("div",null,[r.consentedEnforcement?(i(),o("div",T,[h(p)])):s.isAuthenticated?(i(),o("div",w,[s.archived?(i(),o("div",P,"This thread is archived and is no longer accepting comments.")):(i(),o("div",z,[l("form",{onSubmit:a[2]||(a[2]=b((...n)=>r.submitComment&&r.submitComment(...n),["prevent"]))},[h(y,{value:e.siteUser.displayName,"onUpdate:value":a[0]||(a[0]=n=>e.siteUser.displayName=n),label:"Posting As"},null,8,["value"]),h(N,{value:s.body,"onUpdate:value":a[1]||(a[1]=n=>s.body=n)},null,8,["value"]),h(f,{type:"submit",color:e.$ss.baseStyles.primaryColor,disabled:s.isSubmitDisabled},{default:C(()=>[v(m(s.isSubmitDisabled?"Please Wait":"Submit"),1)]),_:1},8,["color","disabled"]),s.error?(i(),o("p",O,"Error: "+m(s.error.message),1)):d("",!0)],32)]))])):(i(),o("div",A,[h(x,{"call-to-action":"","available-space":r.containerPixelWidth},null,8,["available-space"])])),t.latestCommentsHeader&&s.comments.length?(i(),o("h3",I,m(t.latestCommentsHeader),1)):d("",!0)]),s.isLoading?(i(),o("div",E,"Loading comments...")):s.error?(i(),o("div",B,"Unable to load comments: "+m(s.error.message),1)):s.comments.length===0?(i(),o("div",R," No comments have been added yet. Want to start the conversation? ")):(i(),o("div",q,[(i(!0),o(L,null,k(s.comments,n=>(i(),o("div",{key:n.id,class:"comment"},[l("div",{"data-id":n.id,class:"comment_block"},[l("div",j,[l("span",null,"Posted by "+m(n.user.displayName),1),n.approved?d("",!0):(i(),o("span",H,"(pending moderation)")),n.createdAt?(i(),o("span",K,[v(m(r.formatDate(n.createdAt))+" ",1),s.isAuthenticated&&!n.flagged?(i(),o("span",G,[l("a",{href:"#report-post",title:"Report post as inappropriate.",onClick:b(g=>r.reportComment(n.id),["prevent"])}," Report ",8,J)])):d("",!0)])):d("",!0)]),l("div",null,[n.flagged?(i(),o("p",Q,"This comment has been reported.")):d("",!0),(i(!0),o(L,null,k(n.body.replace(/(<([^>]+)>)/gi,"").split(`
`),g=>(i(),o("p",{key:g},m(g),1))),128))])],8,V)]))),128)),s.hasNextPage?(i(),o("div",X,[h(f,{class:"btn btn-primary",color:e.$ss.baseStyles.primaryColor,disabled:s.isLoadingMore,onOnClick:r.loadMore},{default:C(()=>[s.isLoadingMore?(i(),o("span",Y,"Loading...")):(i(),o("span",Z,"Load More Comments"))]),_:1},8,["color","disabled","onOnClick"])])):d("",!0)]))],4)}var ie=S(M,[["render",$],["__scopeId","data-v-fd84db7a"]]);export{ie as default};
